var Ee=Object.defineProperty;var Ge=(e,t,i)=>t in e?Ee(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i;var o=(e,t,i)=>(Ge(e,typeof t!="symbol"?t+"":t,i),i);const Le=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function i(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerpolicy&&(r.referrerPolicy=n.referrerpolicy),n.crossorigin==="use-credentials"?r.credentials="include":n.crossorigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(n){if(n.ep)return;n.ep=!0;const r=i(n);fetch(n.href,r)}};Le();let Wt=0,Be=300;const Bt={callback:()=>{},animate:e=>{Bt.callback=e}},Ut=()=>{requestAnimationFrame(Ut);let e=Date.now(),t=e-Wt,i=1e3/Be;t>i&&(Wt=e-t%i,Bt.callback())};var Te={},ht={};Object.defineProperty(ht,"__esModule",{value:!0});ht.Vector=void 0;class D{constructor(t=0,i=0,s=0){this.x=t,this.y=i,this.z=s}add(t,i=0,s=0){return typeof t=="number"?(this.x+=t,this.y+=i,this.z+=s,this):(this.x+=t.x,this.y+=t.y,this.z+=t.z,this)}sub(t,i=0,s=0){return typeof t=="number"?(this.x-=t,this.y-=i,this.z-=s,this):(this.x-=t.x,this.y-=t.y,this.z-=t.z,this)}mult(t){return isFinite(t)?(this.x*=t,this.y*=t,this.z*=t,this):this}div(t){return!isFinite(t)||t==0?this:(this.x/=t,this.y/=t,this.z/=t,this)}set(t,i=0,s=0){return typeof t!="number"?(this.x=t.x,this.y=t.y,this.z=t.z,this):(this.x=t,this.y=i,this.z=s,this)}copy(){return new D(this.x,this.y,this.z)}magSq(){return this.x*this.x+this.y*this.y+this.z*this.z}get mag(){return Math.hypot(this.x,this.y,this.z)}set mag(t){this.div(this.mag).mult(t)}normalize(){let t=Math.hypot(this.x,this.y,this.z);return t===0?this.set(0,0,0):this.div(t)}max(t){return this.mag>t.mag?this:t}min(t){return this.mag<t.mag?this:t}equals(t){return this.x===t.x&&this.y===t.y&&this.z===t.z}dist(t){return Math.hypot(this.x-t.x,this.y-t.y,this.z-t.z)}distSq(t){return Math.hypot(this.x-t.x,this.y-t.y,this.z-t.z)**2}cross(t){return new D(this.y*t.z-this.z*t.y,this.z*t.x-this.x*t.z,this.x*t.y-this.y*t.x)}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}maxMag(t){let i=Math.hypot(this.x,this.y,this.z);return i>t?this.div(i).mult(t):this}minMag(t){let i=Math.hypot(this.x,this.y,this.z);return i<t?this.div(i).mult(t):this}constrainMag(t,i){let s=Math.hypot(this.x,this.y,this.z);return s<t?this.div(s).mult(t):s>i?this.div(s).mult(i):this}toArray(){return[this.x,this.y,this.z]}changeOfBasis(t=new D(1),i=new D(0,1),s=new D(0,0,1)){let n=this.x,r=this.y,a=this.z;return this.x=n*t.x+r*i.x+a*s.x,this.y=n*t.y+r*i.y+a*s.y,this.z=n*t.z+r*i.z+a*s.z,this}lerp(t,i){const s=Math.min(Math.max(i,0),1);return this.x+=(t.x-this.x)*s,this.y+=(t.y-this.y)*s,this.z+=(t.z-this.z)*s,this}angleBetween(t){let i=this.mag*t.mag;if(i==0)return 0;let s=this.dot(t)/i;return Math.acos(Math.max(Math.min(s,1),-1))}get direction(){return Math.atan2(this.y,this.x)}set direction(t){this.x=Math.cos(t),this.y=Math.sin(t)}set direction3D(t){this.x=Math.sin(t[1])*Math.cos(t[0]),this.y=Math.sin(t[1])*Math.sin(t[0]),this.z=Math.cos(t[1])}get direction3D(){return[Math.atan2(this.y,this.x),Math.atan2(Math.hypot(this.x,this.y),this.z)]}rotate(t){let i=Math.cos(t),s=Math.sin(t),n=this.x;return this.x=n*i+this.y*-s||0,this.y=n*s+this.y*i||0,this}rotateX(t){let i=Math.cos(t),s=Math.sin(t),n=this.y;return this.y=n*i+this.z*-s||0,this.z=n*s+this.z*i||0,this}rotateY(t){let i=Math.cos(t),s=Math.sin(t),n=this.x;return this.x=n*i+this.z*s||0,this.z=n*-s+this.z*i||0,this}}ht.Vector=D;(function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.createVector=e.one=e.zero=e.back=e.forward=e.down=e.up=e.left=e.right=e.scalarProyection=e.random3D=e.random2D=e.fromAngles=e.fromAngle=e.rotateY=e.rotateX=e.rotate=e.angleBetween=e.lerp=e.changeOfBasis=e.toArray=e.dot=e.cross=e.distSq=e.dist=e.equals=e.min=e.max=e.setMag=e.normalize=e.div=e.mult=e.sub=e.add=e.Vector=void 0;const t=ht;Object.defineProperty(e,"Vector",{enumerable:!0,get:function(){return t.Vector}});const i=(h,u,g=0,S=0)=>u instanceof t.Vector?new t.Vector(h.x+u.x,h.y+u.y,h.z+u.z):new t.Vector(h.x+u,h.y+g,h.z+S);e.add=i;const s=(h,u,g=0,S=0)=>u instanceof t.Vector?new t.Vector(h.x-u.x,h.y-u.y,h.z-u.z):new t.Vector(h.x-u,h.y-g,h.z-S);e.sub=s;const n=(h,u)=>isFinite(u)?new t.Vector(h.x*u,h.y*u,h.z*u):new t.Vector(h.x,h.y,h.z);e.mult=n;const r=(h,u)=>{if(u!==0&&isFinite(u)){let g=1/u;return new t.Vector(h.x*g,h.y*g,h.z*g)}return new t.Vector(h.x,h.y,h.z)};e.div=r;const a=h=>(0,e.div)(h,Math.hypot(h.x,h.y,h.z));e.normalize=a;const l=(h,u)=>(0,e.div)(h,Math.hypot(h.x,h.y,h.z)).mult(u);e.setMag=l;const d=(h,u)=>h.mag>u.mag?h.copy():u.copy();e.max=d;const p=(h,u)=>h.mag<u.mag?h.copy():u.copy();e.min=p;const m=(h,u)=>h.x==u.x&&h.y==u.y&&h.z==u.z;e.equals=m;const z=(h,u)=>Math.hypot(h.x-u.x,h.y-u.y,h.z-u.z);e.dist=z;const A=(h,u)=>Math.hypot(h.x-u.x,h.y-u.y,h.z-u.z)**2;e.distSq=A;const M=(h,u)=>new t.Vector(h.y*u.z-h.z*u.y,h.z*u.x-h.x*u.z,h.x*u.y-h.y*u.x);e.cross=M;const x=(h,u)=>h.x*u.x+h.y*u.y+h.z*u.z;e.dot=x;const I=h=>[h.x,h.y,h.z];e.toArray=I;const C=(h,u=new t.Vector(1),g=new t.Vector(0,1),S=new t.Vector(0,0,1))=>new t.Vector(h.x*u.x+h.y*g.x+h.z*S.x,h.x*u.y+h.y*g.y+h.z*S.y,h.x*u.z+h.y*g.z+h.z*S.z);e.changeOfBasis=C;const L=(h,u,g)=>new t.Vector(h.x+(u.x-h.x)*g,h.y+(u.y-h.y)*g,h.z+(u.z-h.z)*g);e.lerp=L;const B=(h,u)=>{let g=h.mag*u.mag;if(g===0)return 0;let S=h.dot(u)/g;return Math.acos(Math.max(Math.min(S,1),-1))};e.angleBetween=B;const P=(h,u)=>{let g=Math.cos(u),S=Math.sin(u);return new t.Vector(h.x*g+h.y*-S,h.x*S+h.y*g,h.z)};e.rotate=P;const wt=(h,u)=>{let g=Math.cos(u),S=Math.sin(u);return new t.Vector(h.x,h.y*g+h.z*-S,h.y*S+h.z*g)};e.rotateX=wt;const yt=(h,u)=>{let g=Math.cos(u),S=Math.sin(u);return new t.Vector(h.x*g+h.z*S,h.y,h.x*-S+h.z*g)};e.rotateY=yt;const me=h=>new t.Vector(Math.cos(h),Math.sin(h));e.fromAngle=me;const ge=(h,u)=>new t.Vector(Math.sin(u)*Math.cos(h),Math.sin(u)*Math.sin(h),Math.cos(u));e.fromAngles=ge;const we=()=>(0,e.fromAngle)(Math.random()*Math.PI*2);e.random2D=we;const ye=()=>(0,e.fromAngles)(Math.random()*Math.PI*2,Math.random()*Math.PI*2);e.random3D=ye;const ze=(h,u,g)=>{let S=(0,e.sub)(u,h),Fe=(0,e.sub)(g,h);return S.normalize(),S.mult(Fe.dot(S)),(0,e.add)(h,S)};e.scalarProyection=ze;const Se=()=>new t.Vector(1,0,0);e.right=Se;const Me=()=>new t.Vector(-1,0,0);e.left=Me;const be=()=>new t.Vector(0,1,0);e.up=be;const ke=()=>new t.Vector(0,-1,0);e.down=ke;const Ie=()=>new t.Vector(0,0,1);e.forward=Ie;const Ae=()=>new t.Vector(0,0,-1);e.back=Ae;const xe=()=>new t.Vector;e.zero=xe;const Ce=()=>new t.Vector(1,1,1);e.one=Ce;const Oe=(h=0,u=0,g=0)=>new t.Vector(h,u,g);e.createVector=Oe})(Te);const Ne=Math.PI*2,et=(e,t=0,i=0,s=1)=>e instanceof Array?`rgba( ${e[0]}, ${e[1]}, ${e[2]}, ${e[3]||1})`:`rgba( ${e}, ${t}, ${i}, ${s})`;function St(e,t){if(!t){e.fill();return}e.save(),e.fillStyle=t,e.fill(),e.restore()}const qe=(e,t)=>{if(!t){e.fillRect(0,0,e.canvas.width,e.canvas.height);return}e.save(),e.fillStyle=t,e.fillRect(0,0,e.canvas.width,e.canvas.height),e.restore()},ve=(e,t,i,s,n,r,a=!0)=>{e.beginPath(),e.arc(t,i,s||e.lineWidth,n||0,r||Ne,a)},Rt=(e,t,i,s=10,n)=>{e.beginPath(),e.rect(t,i,s,n||s)},Ve=(e,t)=>Math.random()*(t-e)+e,Mt=(e,t,i)=>Math.max(Math.min(e,i),t),De=e=>{e.width=innerWidth,e.height=innerHeight},We=e=>{addEventListener("resize",()=>De(e))},Re=e=>{let t=0,i=e;for(;i instanceof Array;)t+=1,i=i[0];return t},_=e=>{let t=[],i=e;for(;i instanceof Array;)t.push(i.length),i=i[0];return t},He=(e,t,i)=>Math.max(Math.min(e,i),t),Pe=(e,t,i,s,n)=>(e-t)/(i-t)*(n-s)+s,Xt=(e,t)=>Math.random()*(t-e)+e,Ht=e=>Xt(e[0],e[1]),Ye=()=>{let e,t,i;do e=Math.random()*2-1,t=Math.random()*2-1,i=e*e+t*t;while(i>=1||i==0);return e*Math.sqrt(-2*Math.log(i)/i)},_e=(e=0,t=1)=>t*Ye()+e,w=e=>e instanceof c?e:new c(e,_(e)),bt=e=>{let t=(s,n)=>{if(n[0]instanceof Array)for(let r=0;r<n.length;r++)s[r]=[],t(s[r],n[r]);else for(let r=0;r<n.length;r++)s[r]=n[r]},i=w(e);if(i.data instanceof Array){let s=[];return t(s,i.data),new c(s,i.shape)}else return new c(i.data,i.shape)},it=(e,t)=>{if(e.length!==t.length)return!1;for(let i=0;i<e.length;i++)if(e[i]!==t[i])return!1;return!0},Tt=e=>{let t=w(e),i=1;for(let s=0;s<t.shape.length;s++)i*=t.shape[s];return i},$e=(e,t)=>{let i=s=>{if(s[0]instanceof Array)for(let n=0;n<s.length;n++)i(s[n]);else t(s)};return i(e),e},Je=(e,t,i)=>{let s=(n,r)=>{if(n[0]instanceof Array)for(let a=0;a<n.length;a++)s(n[a],r[a]);else i(n,r)};return s(e,t),e},R=(e,t)=>{let i=s=>{if(s[0]instanceof Array)for(let n=0;n<s.length;n++)i(s[n]);else for(let n=0;n<s.length;n++)s[n]=t(s[n])};return e instanceof Array?(i(e),e):t(e)},K=(e,t)=>{let i=(s,n)=>{if(s[0]instanceof Array)for(let r=0;r<s.length;r++)n[r]=[],i(s[r],n[r]);else for(let r=0;r<s.length;r++)n[r]=t(s[r])};if(e instanceof Array){let s=[];return i(e,s),s}return t(e)},Ue=(e,t,i)=>{let s=(n,r)=>{if(n[0]instanceof Array)for(let a=0;a<n.length;a++)s(n[a],r[a]);else for(let a=0;a<n.length;a++)n[a]=i(n[a],r[a])};return e instanceof Array?t instanceof Array?(s(e,t),e):R(e,n=>i(n,t)):t instanceof Array?K(t,n=>i(n,e)):i(e,t)},Xe=(e,t,i)=>{let s=(n,r,a)=>{if(n[0]instanceof Array)for(let l=0;l<n.length;l++)a[l]=[],s(n[l],r[l],a[l]);else for(let l=0;l<n.length;l++)a[l]=i(n[l],r[l])};if(e instanceof Array){if(t instanceof Array){let n=[];return s(e,t,n),n}return K(e,n=>i(n,t))}else if(t instanceof Array)return K(t,n=>i(n,e));return i(e,t)},Ke=(e,t)=>(t=t||_(e),new c(e,t)),Pt=e=>new c(e.data,e.shape),lt=(e,t=[e.length])=>{let i=1;for(let n=0;n<t.length;n++)i*=t[n];if(i!==e.length)throw console.error("Based on the provided shape the tensor should have "+i+" values but has "+e.length);let s=e;for(let n=t.length-1;n>=0;n--){let r=[],a=0;for(let l=0;l<s.length/t[n];l++){r[l]=[];for(let d=0;d<t[n];d++)r[l][d]=s[a],a++}s=r}return s=s[0],new c(s,t)},J=(e,t)=>{let i=1;for(let n=0;n<e.length;n++)i*=e[n];let s=[];for(let n=0;n<i;n++)s[n]=t;return lt(s,e)},Qe=e=>J(e,1),y=e=>J(e,0),Kt=(e,t=_(e))=>!(e[0]instanceof Array)&&t.length>1?lt(e,t):new c(e,t),Ze=(e,t)=>{let i=w(e);return J(i.shape,t)},je=e=>Ze(e,0),ot=(e,t,i)=>{let s=1,n=[];for(let r=0;r<e.length;r++)s*=e[r];for(let r=0;r<s;r++)n[r]=_e(t,i);return lt(n,e)},ut=(e,t,i)=>{let s=1,n=[];for(let r=0;r<e.length;r++)s*=e[r];for(let r=0;r<s;r++)n[r]=Xt(t,i);return lt(n,e)},Qt=e=>{let t=w(e),i=[];return R(t.data,s=>(i.push(s),s)),new c(i,[i.length])},Zt=(e,t)=>jt(Qt(e),t),jt=(e,t)=>{let i=1;for(let n=0;n<t.length;n++)i*=t[n];let s=w(e);if(i==s.data.length){let n=s.data;for(let r=t.length-1;r>=0;r--){let a=[],l=0;for(let d=0;d<n.length/t[r];d++){a[d]=[];for(let p=0;p<t[r];p++)a[d][p]=n[l],l++}n=a}return n=n[0],new c(n,t)}else throw console.error("Based on the provided shape the tensor should have "+i+" values but has "+s.data.length)},te=(e,t)=>{let i=w(e);if(t.length!==i.rank)throw console.error("Dimentions in reps "+t+" does not match with the number of dimentions from tensor "+i.shape);let s=[];for(let a=0;a<i.rank;a++)s[a]=t[a]*i.shape[a];let n=[],r=(a,l,d)=>{if(a[0]instanceof Array)for(let p=0;p<s[d];p++)l[p]=[],r(a[p%i.shape[d]],l[p],d+1);else for(let p=0;p<s[s.length-1];p++)l[p]=a[p%i.shape[i.rank-1]]};return r(i.data,n,0),Ke(n,s)},ee=(e,t)=>{let i=e.slice(),s=t.slice();if(i.length>s.length)for(;s.length<i.length;)s.unshift(1);else for(;i.length<s.length;)i.unshift(1);let n=[];for(let r=0;r<i.length;r++)n[r]=Math.max(i[r],s[r]);return n},kt=(e,t)=>{let i=w(e),s=i.shape.slice();if(t.length<i.rank)throw console.error("Rank from shape "+t.length+" is minor than tensor rank "+i.rank);let n=i;if(t.length>i.rank){let a=s.slice();for(;a.length<t.length;)a.unshift(1);n=Zt(i,a)}let r=t.slice();for(let a=0;a<t.length;a++)if(n.shape[a]===t[a])r[a]=1;else if(n.shape[a]!==1)throw console.error(s+" cannot be broadcast to "+t);return te(n,r)},ti=e=>{let t=e.length-1;for(;t>0;){let i=Math.floor(Math.random()*t+1),s=e[t];e[t]=e[i],e[i]=s,t-=1}return e},ei=(e,t)=>{let i=e.length-1;for(;i>0;){let s=Math.floor(Math.random()*i+1),n=e[i],r=t[i];e[i]=e[s],t[i]=t[s],e[s]=n,t[s]=r,i-=1}return[e,t]},q=e=>(t,i)=>{let s=w(t),n=w(i),r=s.shape;return it(s.shape,n.shape)||(r=ee(s.shape,n.shape),s=kt(s,r),n=kt(n,r)),new c(Xe(s.data,n.data,(a,l)=>e(a,l)),r)},T=q((e,t)=>e+t),O=q((e,t)=>e-t),f=q((e,t)=>e*t),dt=q((e,t)=>e/t),b=q((e,t)=>t==0?0:e/t),ii=q((e,t)=>Math.floor(e/t)),si=q((e,t)=>Math.floor(t==0?0:e/t)),ni=q((e,t)=>e**t),ie=q((e,t)=>(e-t)*(e-t)),pt=e=>{let t=w(e),i=-1/0;return R(t.data,s=>(i=s>i?s:i,s)),i},Q=e=>{let t=0,i=0,s=w(e);return R(s.data,n=>(i++,t+=n,n)),t/i},Nt=e=>{let t=w(e),i=0;return R(t.data,s=>(i+=s,s)),i},ct=e=>{let t=w(e),i=0;return R(t.data,s=>(i+=Math.exp(He(s,-50,50)),s)),i},k=e=>t=>{let i=w(t),s=K(i.data,n=>e(n));return new c(s,i.shape)},ri=k(e=>-e),ft=k(e=>Math.exp(e)),st=k(e=>Math.log(e)),ai=k(e=>Math.sqrt(e)),$=k(e=>e*e),hi=k(e=>Math.tanh(e)),li=k(e=>1-e**2),oi=k(e=>1/(1+Math.exp(-e))),ui=k(e=>e*(1-e)),di=k(e=>Math.max(0,e)),pi=k(e=>e>0?1:0),ci=k(e=>Math.max(.05*e,e)),fi=k(e=>e>0?1:.05),mi=k(e=>e>0?e:.05*(Math.exp(e)-1)),gi=k(e=>e>0?1:.05+e),wi=k(e=>Math.log(1+Math.exp(e))),yi=k(e=>1/(1+Math.exp(-e))),zi=k(e=>e>0?1:0),Si=e=>je(e),Mi=e=>{let t=w(e);return Q($(O(t,Q(t))))},bi=e=>{let t=w(e),i=O(t,pt(t));return dt(ft(i),ct(i))},ki=e=>{let t=w(e),i=[],s=t.shape[0];for(let n=0;n<s;n++){i[n]=[];for(let r=0;r<s;r++)n==r?i[n][r]=t.data[n]*(1-t.data[n]):i[n][r]=-t.data[n]*t.data[r]}return new c(i,[s,s],2)},se=(e,t)=>{if(e.shape[1]!==t.shape[0])throw console.error("Colums of A must match rows of B");let i=[];for(let s=0;s<e.shape[0];s++){i[s]=[];for(let n=0;n<t.shape[1];n++){let r=0;for(let a=0;a<e.shape[1];a++)r+=e.data[s][a]*t.data[a][n];i[s][n]=r}}return new c(i,[e.shape[0],t.shape[1]])},ne=(e,t)=>{if(e.shape[1]!==t.shape[0])throw console.error("Colums of A must match rows of B");let i=[];for(let s=0;s<e.shape[0];s++){let n=0;for(let r=0;r<e.shape[1];r++)n+=e.data[s][r]*t.data[r];i[s]=n}return new c(i,[e.shape[0]])},re=(e,t)=>{if(t.shape[0]!==1)throw console.error("Colums of A must match rows of B");let i=[];for(let s=0;s<e.shape[0];s++){i[s]=[];for(let n=0;n<t.shape[1];n++)i[s][n]=e.data[s]*t.data[0][n]}return new c(i,[e.shape[0],t.shape[1]])},ae=(e,t)=>{if(e.shape[0]!==t.shape[0])throw console.error("Colums of A must match rows of B");let i=0;for(let s=0;s<e.shape[0];s++)i+=e.data[s]*t.data[s];return new c(i,[])},X=(e,t)=>e.rank==2?t.rank==2?se(e,t):ne(e,t):t.rank==2?re(e,t):ae(e,t),Ii=e=>{let t=w(e),i=[];for(let s=0;s<t.shape[0];s++){i[s]=[];for(let n=0,r=t.shape[1]-1;n<r;n++,r--)i[s][n]=t.data[s][r],i[s][r]=t.data[s][n]}return new c(i,t.shape)},Ai=e=>{let t=w(e),i=[];for(let s=0;s<t.shape[1];s++)i[s]=[];for(let s=0;s<t.shape[1];s++)for(let n=0,r=t.shape[0]-1;n<r;n++,r--)i[n][s]=t.data[r][s],i[r][s]=t.data[n][s];return new c(i,t.shape)},qt=(e,t)=>{let i=w(e);if(t[0]==0&&t[1]==0)return i;let s=t[0],n=t[1],r=Math.floor(t[0]/2),a=t[0]-r,l=Math.floor(t[1]/2),d=t[1]-l,p=[];for(let m=0;m<i.shape[1];m++){p[m]=i.data[m].slice();for(let z=0;z<l;z++)p[m].unshift(0);for(let z=0;z<d;z++)p[m].push(0)}for(let m=0;m<r;m++)p.unshift(new Array(p[0].length).fill(0));for(let m=0;m<a;m++)p.push(new Array(p[0].length).fill(0));return new c(p,[i.shape[0]+s,i.shape[1]+n])},xi=e=>{let t=w(e),i=[],s=0,n=0;for(let r=0;r<t.shape[1];r++){i[n]=[],s=0;for(let a=t.shape[0]-1;a>=0;a--)i[n][s]=t.data[a][r],s++;n++}return new c(i,[t.shape[1],t.shape[0]])},he=e=>{let t=w(e),i=[];for(let s=0;s<t.shape[0];s++){i[s]=t.data[s].slice();for(let n=0,r=t.shape[1]-1;n<r;n++,r--)i[s][n]=t.data[s][r],i[s][r]=t.data[s][n]}for(let s=0;s<t.shape[1];s++)for(let n=0,r=t.shape[0]-1;n<r;n++,r--)i[n][s]=t.data[r][s],i[r][s]=t.data[n][s];return new c(i,t.shape)},Ci=e=>{let t=w(e),i=[],s,n=0;for(let r=t.shape[1]-1;r>=0;r--){i[n]=[],s=0;for(let a=0;a<t.shape[0];a++)i[n][s]=t.data[a][r],s++;n++}return new c(i,[t.shape[1],t.shape[0]])},It=e=>{let t=w(e);if(t.rank==2){let i=[];for(let s=0;s<t.shape[1];s++){i[s]=[];for(let n=0;n<t.shape[0];n++)i[s][n]=t.data[n][s]}return new c(i,[t.shape[1],t.shape[0]])}else{let i=[[]];for(let s=0;s<t.shape[0];s++)i[0][s]=t.data[s];return new c(i,[1,t.shape[0]])}};class c{constructor(t,i=[],s=i.length){o(this,"data");o(this,"shape");o(this,"rank");this.data=t,this.shape=i,this.rank=s}set(t){return this.data=t.data,this.shape=t.shape,this.rank=t.rank,this}setData(t,i,s){return this.data=t,this.shape=i||_(t),this.rank=s||this.shape.length,this}add(t){return this.set(T(this,t))}sub(t){return this.set(O(this,t))}mult(t){return this.set(f(this,t))}div(t){return this.set(dt(this,t))}divNoNan(t){return this.set(b(this,t))}floorDiv(t){return this.set(ii(this,t))}floorDivNoNan(t){return this.set(si(this,t))}pow(t){return this.set(ni(this,t))}sqd(t){return this.set(ie(this,t))}square(){return this.set($(this))}sqrt(){return this.set(ai(this))}remap(t,i,s,n){return this.map(r=>Pe(r,t,i,s,n))}map(t){return this.forEach(i=>t(i)),this}neg(){return this.set(ri(this))}log(){return this.forEach(t=>t==0?-1e3:Math.log(t)),this}constrain(t,i=1){let s,n;return t instanceof Array?(s=t[0],n=t[1]):(s=t,n=i),this.forEach(r=>Math.max(Math.min(r,n),s)),this}exp(){return this.set(ft(this))}dot(t){return this.set(X(this,t))}dotMxM(t){return this.set(se(this,t))}dotMxV(t){return this.set(ne(this,t))}dotVxM(t){return this.set(re(this,t))}dotVxV(t){return this.set(ae(this,t))}transpose(){return this.set(It(this))}mirrorHorizontally(){return this.set(Ii(this))}mirrorVertically(){return this.set(Ai(this))}rotate180(){return this.set(he(this))}rotate90(){return this.set(xi(this))}rotate270(){return this.set(Ci(this))}shuffle(){return this.setData(ti(this.data))}fill(t=0){return this.forEach(()=>t),this}size(){return Tt(this)}rangeOfValues(){let t=-1/0,i=1/0;return this.forEach(s=>(t=s>t?s:t,i=s<i?s:i,s)),[i,t]}shapesEqual(t){return it(this.shape,t)}inferShape(){return _(this.data)}inferRank(){return Re(this.data)}copy(){return bt(this)}randomize(t=[]){let i=t[0]==null?-1:t[0],s=t[1]==null?1:t[1];return t[2]==null?this.forEach(()=>Math.random()*(s-i)+i):this.forEach(()=>Math.floor(Math.random()*(s+1-i)+i)),this}mean(){return Q(this)}sumExp(){return ct(this)}max(){return pt(this)}sum(){return Nt(this)}flatten(){return this.set(Qt(this))}reshape(t){return Zt(this,t)}vectorToTensor(t){return this.set(jt(this,t))}tile(t){return this.set(te(this,t))}broadcastTo(t){return this.set(kt(this,t))}broadcastArgs(t){return ee(this.shape,t)}forEach(t){return R(this.data,t)}forEachOfBoth(t,i){return Ue(this.data,t,i)}accesLastArray(t){return $e(this.data,t)}accesLastArrays(t,i){return Je(this.data,t,i)}static serialize(t){return JSON.stringify(t)}static deserialize(t){return typeof t=="string"&&(t=JSON.parse(t)),new c(t.data,t.shape)}}const At=(e,t,i,s)=>[e[0],Math.floor((e[1]+t[0]-i[0])/s[0]+1),Math.floor((e[2]+t[1]-i[1])/s[1]+1)],xt=(e,t,i,s)=>{if(!t)return[0,0];let n=[Math.floor((e[e.length-2]-i[0])/s[0])+1,Math.floor((e[e.length-1]-i[1])/s[1])+1],r=[i[0]+(n[0]-1)*s[0],i[1]+(n[1]-1)*s[1]],a=[e[e.length-2]-r[0],e[e.length-1]-r[1]];return[a[0]>0?i[0]-a[0]:0,a[1]>0?i[1]-a[1]:0]},Oi=(e,t,i=[2,2],s=i,n=[])=>{n=[];let r=w(e),a=t instanceof Array?t:xt(r.shape,t,i,s),l=[];for(let m=0;m<r.shape[0];m++)l[m]=qt(r.data[m],a).data;l=Kt(l);let d=At(r.shape,a,i,s),p=y(d);for(let m=0;m<l.shape[0];m++)for(let z=0;z<d[1];z++)for(let A=0;A<d[2];A++){let M=-1/0,x=[];for(let I=0;I<i[0];I++)for(let C=0;C<i[1];C++){let L=I+z*s[0],B=C+A*s[1];l.data[m][L][B]>M&&(M=l.data[m][L][B],x=[m,L,B,z,A])}n.push(x),p.data[m][z][A]=M}return p},Fi=(e,t,i,s,n)=>{let r=[(e[0]+i[0]-n[0]*(t[0]-1)-1)/s[0]+1,(e[1]+i[1]-n[1]*(t[1]-1)-1)/s[1]+1];return r=[Math.floor(r[0]),Math.floor(r[1])],r},Ct=(e,t,i,s,n)=>{let r=[t[0],(e[1]+i[0]-n[0]*(t[2]-1)-1)/s[0]+1,(e[2]+i[1]-n[1]*(t[3]-1)-1)/s[1]+1];return r=[Math.floor(r[0]),Math.floor(r[1]),Math.floor(r[2])],r},Ei=(e,t,i,s=[1,1])=>{i=i||s;let n=[e[e.length-2],e[e.length-1]],r=[t[t.length-2],t[t.length-1]],a=Math.floor(s[0]*(r[0]-1)+(n[0]-1)*(i[0]-1)),l=Math.floor(s[1]*(r[1]-1)+(n[1]-1)*(i[1]-1));return[a,l]},Gi=e=>{let t=[e[e.length-2],e[e.length-1]];return[(t[0]-1)*2,(t[1]-1)*2]},nt=(e,t,i,s,n=[1,1])=>i==="same"?Ei(e,t,s,n):i==="full"?Gi(t):[0,0],le=(e,t,i=[0,0],s=[1,1],n=[1,1])=>{let r=w(e),a=w(t),l=i instanceof Array?i:nt(r.shape,a.shape,i,s,n),d=Fi(r.shape,a.shape,l,s,n),p=qt(r,l),m=[];for(let z=0;z<d[0];z++){m[z]=[];for(let A=0;A<d[1];A++){let M=0;for(let x=0;x<a.shape[0];x++)for(let I=0;I<a.shape[1];I++){let C=x*n[0]+z*s[0],L=I*n[1]+A*s[1];M+=p.data[C][L]*a.data[x][I]}m[z][A]=M}}return new c(m,d)},Li=(e,t,i=[0,0],s=[1,1],n=[1,1])=>{let r=he(t);return le(e,r,i,s,n)},Bi=(e,t,i,s=[0,0],n=[1,1],r=[1,1])=>{let a=w(e),l=w(t),d=w(i),p=s instanceof Array?s:nt(a.shape,l.shape,s,n,r),m=[];for(let M=0;M<a.shape[0];M++)m[M]=qt(a.data[M],p).data;m=new c(m,_(m));let z=Ct(a.shape,l.shape,p,n,r),A=y(z);for(let M=0;M<l.shape[0];M++)for(let x=0;x<a.shape[0];x++)for(let I=0;I<z[1];I++)for(let C=0;C<z[2];C++){let L=0;for(let B=0;B<l.shape[2];B++)for(let P=0;P<l.shape[3];P++){let wt=B*r[0]+I*n[0],yt=P*r[1]+C*n[1];L+=m.data[x][wt][yt]*l.data[M][x][B][P]}A.data[M][I][C]+=L+d.data[M][I][C]/z[0]}return A},H=(e,t)=>f(e,t),Ti=(e,t)=>X(t,e),Ni={forward:e=>e,backward:e=>Qe(e.shape),updateError:e=>e,name:"linear"},Yt={forward:e=>oi(e),backward:e=>ui(e),updateError:H,name:"sigmoid"},qi={forward:e=>di(e),backward:e=>pi(e),updateError:H,name:"relu"},vi={forward:e=>ci(e),backward:e=>fi(e),updateError:H,name:"leakyrelu"},Vi={forward:e=>mi(e),backward:e=>gi(e),updateError:H,name:"elu"},Di={forward:e=>wi(e),backward:e=>yi(e),updateError:H,name:"softplus"},Wi={forward:e=>zi(e),backward:e=>Si(e),updateError:H,name:"binarystep"},Ri={forward:e=>hi(e),backward:e=>li(e),updateError:H,name:"tanh"},Hi={forward:e=>bi(e),backward:e=>ki(e),updateError:Ti,name:"softmax"},Pi=e=>{switch(e){case"linear":return Ni;case"sigmoid":return Yt;case"relu":return qi;case"leakyrelu":return vi;case"elu":return Vi;case"softplus":return Di;case"binarystep":return Wi;case"tanh":return Ri;case"softmax":return Hi;default:return Yt}},U=e=>{e.map(s=>Math.floor(s));let t=1,i=1;if(e.length==2)t=e[1],i=e[0];else if(e.length==4){let s=e[2]*e[3];t=s*e[1],i=s*e[0]}return[t,i]},Yi=(e,t=0)=>J(e,t),_i=e=>J(e,1),$i=e=>J(e,0),_t=(e,t,i)=>{let s=U(e)[0]||1;s=1/Math.sqrt(s);let n=t||-s;return ut(e,n,i||s)},Ji=(e,t=0,i=1)=>ot(e,t,i),Ui=e=>{let t=U(e),i=t[0]||1,s=t[1]||1,n=Math.sqrt(6)/Math.sqrt(i+s);return ut(e,-n,n)},Xi=e=>{let t=U(e),i=t[0]||1,s=t[1]||1,n=Math.sqrt(2/(i+s));return ot(e,0,n)},Ki=e=>{let i=U(e)[0]||1,s=Math.sqrt(6/i);return ut(e,-s,s)},Qi=e=>{let i=U(e)[0]||1,s=Math.sqrt(2/i);return ot(e,0,s)},Zi=(e,t=1,i="fan_out",s="uniform")=>{let n=U(e),r=n[0]||1,a=n[1]||1,l=r;if(i=="fan_out"?l=a:i=="avg"&&(l=(r+a)/2),s=="uniform"){let p=Math.sqrt(3*t/l);return ut(e,-p,p)}let d=Math.sqrt(t/l);return ot(e,0,d)},V=e=>{switch(e){case"constant":return Yi;case"ones":return _i;case"zeros":return $i;case"randomUniform":return _t;case"randomNormal":return Ji;case"xavierUniform":return Ui;case"xavierNormal":return Xi;case"heUniform":return Ki;case"heNormal":return Qi;case"varianceScaling":return Zi;default:return _t}},ji=(e,t)=>Q(ie(t,e)),ts=(e,t)=>dt(f(2,O(e,t)),Tt(e)),es=(e,t)=>-Nt(f(t,st(e))),is=(e,t)=>f(t,b(-1,e)),ss=(e,t)=>{let i=O(e,pt(e)),s=dt(ft(i),ct(i));return-Nt(f(t,st(s)))},ns=(e,t)=>{let i=O(e,pt(e)),s=b(ft(i),ct(i));return O(s,t)},rs=(e,t)=>{let i=f(t,st(e)),s=O(1,t),n=st(O(1,e)),r=T(i,f(s,n));return-Q(r)},as=(e,t)=>{let i=b(O(1,t),O(1,e)),s=b(t,e),n=O(i,s);return b(n,Tt(n))},$t={forward:ji,backward:ts},hs={forward:es,backward:is},ls={forward:ss,backward:ns},os={forward:rs,backward:as},zt=e=>{switch(e){case"mse":return $t;case"crossEntropy":return hs;case"softmaxCrossEntropy":return ls;case"binaryCrossEntropy":return os;default:return $t}};class mt{constructor(){o(this,"args");o(this,"name");this.args=[],this.name=""}apply(t,i=0){return f(t[0],i)}}class us extends mt{constructor(t){super(),this.name="sgd",this.args=t}apply(t){return f(t[0],this.args[0])}}const rt=(e=.1)=>new us([e]);class ds extends mt{constructor(t){super(),this.name="momentum",this.args=t}apply(t){return t[1]==null?f(f(t[0],1-this.args[1]),this.args[0]):(t[1]=f(t[1],this.args[1]).add(f(t[0],1-this.args[1])),f(t[1],this.args[0]))}}const ps=(e=.1,t=.9)=>new ds([e,t]);class cs extends mt{constructor(t){super(),this.name="rmsprop",this.args=t}apply(t){if(t[1]==null){let i=f($(t[0]),1-this.args[1]);return f(b(t[0],T(i,this.args[2]).sqrt()),this.args[0])}else return t[1]=f(t[1],this.args[1]).add(f($(t[0]),1-this.args[1])),f(b(t[0],T(t[1],this.args[2]).sqrt()),this.args[0])}}const fs=(e=.01,t=.9,i=1e-7)=>new cs([e,t,i]);class ms extends mt{constructor(t){super(),this.name="adam",this.args=t}apply(t,i=0){if(t[1]==null){let s=f(t[0],1-this.args[1]),n=f($(t[0]),1-this.args[2]),r=b(s,1-this.args[1]),a=b(n,1-this.args[2]);return f(b(r,T(a,this.args[3]).sqrt()),this.args[0])}else{t[1]=T(f(t[1],this.args[1]),f(t[0],1-this.args[1])),t[2]=T(f(t[2],this.args[2]),f($(t[0]),1-this.args[2]));let s=b(t[1],1-this.args[1]**i),n=b(t[2],1-this.args[2]**i);return f(b(s,T(n,this.args[3]).sqrt()),this.args[0])}}}const gs=(e=.1,t=.9,i=.999,s=1e-7)=>new ms([e,t,i,s]),ws=e=>{switch(e.name){case"sgd":return rt(...e.args);case"momentum":return ps(...e.args);case"rmsprop":return fs(...e.args);case"adam":return gs(...e.args);default:return rt()}};class j{constructor(){o(this,"input");o(this,"type");o(this,"isTrainable");o(this,"name");o(this,"output");this.input=[new c([])],this.output=[new c([])],this.type="",this.name="",this.isTrainable=!1}forward(t){return t}backward(t){return t}serialize(){return JSON.stringify(this)}}class gt extends j{constructor(){super();o(this,"weights");o(this,"bias");o(this,"weightsGradient");o(this,"biasGradient");o(this,"biasConstrain");o(this,"weightsConstrain");o(this,"optimizerWeights");o(this,"optimizerBias");o(this,"weightsInitializer");o(this,"weightsInitializerFunction");o(this,"biasInitializer");o(this,"biasInitializerFunction");o(this,"parameters");this.name=this.type,this.weights=new c([]),this.bias=new c([]),this.weightsConstrain=[-1e7,1e7],this.biasConstrain=[-1e7,1e7],this.weightsGradient=new c([]),this.biasGradient=new c([]),this.optimizerWeights=[this.weightsGradient],this.optimizerBias=[this.weightsGradient],this.weightsInitializer="xavierNormal",this.weightsInitializerFunction=V(this.weightsInitializer),this.biasInitializer="zeros",this.biasInitializerFunction=V(this.biasInitializer),this.parameters=0}reshapeOptimizerParameters(){this.weightsGradient=y(this.weights.shape),this.biasGradient=y(this.bias.shape),this.optimizerWeights=[this.weightsGradient,y(this.weights.shape),y(this.weights.shape)],this.optimizerBias=[this.biasGradient,y(this.bias.shape),y(this.bias.shape)]}update(i,s=1,n=0){this.weightsGradient.divNoNan(s),this.biasGradient.divNoNan(s);let r=i.apply(this.optimizerWeights,n),a=i.apply(this.optimizerBias,n);this.weights.sub(r),this.bias.sub(a),this.weights.constrain(this.weightsConstrain),this.bias.constrain(this.biasConstrain),this.weightsGradient.mult(0),this.biasGradient.mult(0)}setParameters(i){this.setWeights(Pt(i.weights)),this.setBias(Pt(i.bias))}setWeights(i){let s=bt(i);if(!it(s.shape,this.weights.shape))throw"Weights shapes don't match";this.weights=s}getWeights(){return this.weights.copy()}setBias(i){let s=bt(i);if(!it(s.shape,this.bias.shape))throw"Bias shapes don't match";this.bias=s}getBias(){return this.bias.copy()}mutate(i=.1,s){this.mutateWeights(i,s),this.mutateBias(i,s)}mutateWeights(i,s){this.weights.map(n=>Math.random()<i?Ht(s):n)}mutateBias(i,s){this.bias.map(n=>Math.random()<i?Ht(s):n)}save(){return{weights:this.getWeights(),bias:this.getBias()}}}class Ot extends gt{constructor(i){super();o(this,"units");o(this,"outputShape");o(this,"inputShape");this.type="dense",this.isTrainable=!0,this.units=Math.floor(i.units),this.outputShape=this.units,this.weightsInitializer=i.weightsInitializer||"xavierNormal",this.weightsInitializerFunction=V(this.weightsInitializer),this.biasInitializer=i.biasInitializer||"zeros",this.biasInitializerFunction=V(this.biasInitializer),this.inputShape=i.inputShape?Math.floor(i.inputShape):1,this.weights=this.weightsInitializerFunction([this.units,this.inputShape]),this.bias=this.biasInitializerFunction([this.units]),this.weightsConstrain=i.weightsConstrain||[-1e7,1e7],this.biasConstrain=i.biasConstrain||[-1e7,1e7],this.weightsGradient=y(this.weights.shape),this.biasGradient=y(this.bias.shape),this.optimizerWeights=[this.weightsGradient,y(this.weights.shape),y(this.weights.shape)],this.optimizerBias=[this.biasGradient,y(this.bias.shape),y(this.bias.shape)],this.parameters=this.units*this.inputShape+this.outputShape,i.weights!==void 0&&this.setParameters(i)}resize(i){this.inputShape=i instanceof Array?i[0]:i,this.weights=this.weightsInitializerFunction([this.units,this.inputShape]),this.bias=this.biasInitializerFunction([this.units]),this.reshapeOptimizerParameters(),this.parameters=this.units*this.inputShape+this.outputShape}forward(i){this.input=i;for(let s=0;s<this.input.length;s++)this.output[s]=X(this.weights,this.input[s]).add(this.bias);return this.output}backward(i){let s=It(this.weights),n=[];for(let r=0;r<i.length;r++){let a=i[r],l=It(this.input[r]),d=X(a,l);this.weightsGradient.add(d),this.biasGradient.add(a),n[r]=X(s,a)}return n}save(){return{type:this.type,weights:this.weights,bias:this.bias,weightsInitializer:this.weightsInitializer,biasInitializer:this.biasInitializer,inputShape:this.inputShape,units:this.units,outputShape:this.outputShape,weightsConstrain:this.weightsConstrain,biasConstrain:this.biasConstrain}}}class ys extends gt{constructor(i){super();o(this,"filters");o(this,"padding");o(this,"kernelSize");o(this,"inputShape");o(this,"stride");o(this,"dilation");o(this,"kernelShape");o(this,"padAmt");o(this,"kernelGradientPad");o(this,"inputGradientPad");o(this,"outputShape");this.type="conv",this.name=this.type,this.isTrainable=!0,this.filters=Math.floor(i.filters),this.padding=i.padding||"valid",i.weightsConstrain&&(this.weightsConstrain=i.weightsConstrain),i.biasConstrain&&(this.biasConstrain=i.biasConstrain),this.weightsInitializer=i.weightsInitializer||"xavierNormal",this.weightsInitializerFunction=V(this.weightsInitializer),this.biasInitializer=i.biasInitializer||"zeros",this.biasInitializerFunction=V(this.biasInitializer),this.kernelSize=typeof i.kernelSize=="number"?this.kernelSize=[i.kernelSize,i.kernelSize]:[i.kernelSize[0],i.kernelSize[1]],this.kernelSize.map(s=>Math.floor(s)),this.stride=[1,1],i.stride&&(this.stride=i.stride instanceof Array?i.stride:[i.stride,i.stride],this.stride.map(s=>Math.floor(s))),this.dilation=[1,1],i.dilation&&(this.dilation=i.dilation instanceof Array?i.dilation:[i.dilation,i.dilation],this.dilation.map(s=>Math.floor(s))),this.kernelGradientPad="valid",this.inputGradientPad="full",this.padding=="same"&&(this.kernelGradientPad=[this.kernelSize[0]-1,this.kernelSize[1]-1],this.inputGradientPad="same"),this.inputShape=i.inputShape?i.inputShape.slice():[1,1,1],this.inputShape.map(s=>Math.floor(s)),this.kernelShape=[this.filters,this.inputShape[0],this.kernelSize[0],this.kernelSize[1]],this.padAmt=nt(this.inputShape,this.kernelShape,this.padding,this.stride,this.dilation),this.outputShape=Ct(this.inputShape,this.kernelShape,this.padAmt,this.stride,this.dilation),this.weights=this.weightsInitializerFunction(this.kernelShape),this.bias=this.biasInitializerFunction(this.outputShape),this.weightsGradient=y(this.weights.shape),this.biasGradient=y(this.bias.shape),this.optimizerWeights=[this.weightsGradient,y(this.weights.shape),y(this.weights.shape)],this.optimizerBias=[this.biasGradient,y(this.bias.shape),y(this.bias.shape)],this.parameters=this.weights.size()+this.bias.size(),i.weights!==void 0&&this.setParameters(i)}resize(i){this.inputShape=i instanceof Array?i:[1,1,1],this.inputShape.map(s=>Math.floor(s)),this.kernelShape=[this.filters,this.inputShape[0],this.kernelSize[0],this.kernelSize[1]],this.padAmt=nt(this.inputShape,this.kernelShape,this.padding,this.stride,this.dilation),this.outputShape=Ct(this.inputShape,this.kernelShape,this.padAmt,this.stride,this.dilation),this.weights=this.weightsInitializerFunction(this.kernelShape),this.bias=this.biasInitializerFunction(this.outputShape),this.weightsGradient=y(this.weights.shape),this.biasGradient=y(this.bias.shape),this.optimizerWeights=[this.weightsGradient,y(this.weights.shape),y(this.weights.shape)],this.optimizerBias=[this.biasGradient,y(this.bias.shape),y(this.bias.shape)],this.parameters=this.weights.size()+this.bias.size()}forward(i){this.input=i;for(let s=0;s<this.input.length;s++)this.output[s]=Bi(this.input[s],this.weights,this.bias,this.padAmt,this.stride,this.dilation);return this.output}backward(i){let s=i,n=[];for(let r=0;r<i.length;r++){n[r]=y(this.inputShape);let a=[];for(let l=0;l<this.kernelShape[0];l++){a[l]=[];for(let d=0;d<this.kernelShape[1];d++){a[l][d]=le(this.input[r].data[d],s[r].data[l],this.kernelGradientPad).data;let p=Li(s[r].data[l],this.weights.data[l][d],this.inputGradientPad);n[r].data[d]=T(n[r].data[d],p).data}}a=new c(a,this.kernelShape),this.weightsGradient.add(a),this.biasGradient.add(s[r])}return n}save(){return{type:this.type,filters:this.filters,padding:this.padding,weightsInitializer:this.weightsInitializer,biasInitializer:this.biasInitializer,kernelSize:this.kernelSize,inputShape:this.inputShape,stride:this.stride,dilation:this.dilation,weightsConstrain:this.weightsConstrain,biasConstrain:this.biasConstrain,weights:this.weights,bias:this.bias}}}class zs extends j{constructor(i={}){super();o(this,"inputShape");o(this,"outputShape");this.type="flatten",this.inputShape=i.inputShape instanceof Array?i.inputShape.slice():[1,1,1],this.inputShape.map(s=>Math.floor(s)),this.outputShape=1;for(let s=0;s<this.inputShape.length;s++)this.outputShape*=this.inputShape[s]}resize(i){this.inputShape=i instanceof Array?i.slice():[1,1,1],this.inputShape.map(s=>Math.floor(s)),this.outputShape=1;for(let s=0;s<this.inputShape.length;s++)this.outputShape*=this.inputShape[s]}forward(i){this.input=i;let s=[];for(let n=0;n<i.length;n++){let r=[];i[n].forEach(a=>(r.push(a),a)),s[n]=new c(r,[this.outputShape])}return s}backward(i){let s=[];for(let n=0;n<i.length;n++){let r=[],a=0;for(let l=0;l<this.inputShape[0];l++){r[l]=[];for(let d=0;d<this.inputShape[1];d++){r[l][d]=[];for(let p=0;p<this.inputShape[2];p++)r[l][d][p]=i[n].data[a],a++}}s[n]=new c(r,this.inputShape)}return s}serialize(){return JSON.stringify(this)}save(){return{type:this.type,inputShape:this.inputShape}}}class Ss extends j{constructor(i={}){super();o(this,"rate");o(this,"inputShape");o(this,"outputShape");this.type="dropout",this.rate=i.rate||.1,this.inputShape=i.inputShape?i.inputShape:1,this.outputShape=this.inputShape}resize(i){this.inputShape=i,this.outputShape=this.inputShape}forward(i){this.input=i;let s=[];for(let n=0;n<i.length;n++)s[n]=new c(K(i[n].data,r=>Math.random()<this.rate?0:r),i[n].shape);return s}backward(i){return i}serialize(){return JSON.stringify(this)}save(){return{type:this.type,rate:this.rate,inputShape:this.inputShape}}}class oe extends gt{constructor(i={}){super();o(this,"inputShape");o(this,"internInputShape");o(this,"norm");o(this,"xmu");o(this,"variance");o(this,"outputShape");this.type="norm",this.isTrainable=!0,this.inputShape=1,i.inputShape instanceof Array&&(this.inputShape=i.inputShape.slice().map(s=>Math.floor(s))),typeof i.inputShape=="number"&&(this.inputShape=Math.floor(i.inputShape)),this.outputShape=this.inputShape,this.internInputShape=this.inputShape instanceof Array?this.inputShape.slice().map(s=>Math.floor(s)):[Math.floor(this.inputShape)],this.weightsInitializer=i.weightsInitializer||"ones",this.weightsInitializerFunction=V(this.weightsInitializer),this.biasInitializer=i.biasInitializer||"zeros",this.biasInitializerFunction=V(this.biasInitializer),this.weights=this.weightsInitializerFunction(this.internInputShape),this.bias=this.biasInitializerFunction(this.internInputShape),this.reshapeOptimizerParameters(),this.norm=new c([]),this.xmu=new c([]),this.variance=0,i.weights!==void 0&&this.setParameters(i)}resize(i){this.inputShape=i instanceof Array?i.slice().map(s=>Math.floor(s)):Math.floor(i),this.outputShape=this.inputShape,this.internInputShape=i instanceof Array?i.slice().map(s=>Math.floor(s)):[Math.floor(i)],this.weights=this.weightsInitializerFunction(this.internInputShape),this.bias=this.biasInitializerFunction(this.internInputShape),this.reshapeOptimizerParameters(),this.parameters=this.weights.size()+this.bias.size()}forward(i){this.input=i;for(let s=0;s<i.length;s++){this.xmu=O(this.input[s],this.input[s].mean()),this.variance=Mi(this.input[s])+1e-7,this.norm=b(this.xmu,this.variance**.5);let n=f(this.weights,this.norm).add(this.bias);this.output[s]=n}return this.output}backward(i){let s=[];for(let n=0;n<i.length;n++){let r=this.output[n],a=f(r,this.norm);this.weightsGradient.add(a),this.biasGradient.add(r);let l=1/this.variance**.5;s[n]=f(r,this.weights);let d=f(s[n],this.xmu).mult(-.5).mult(this.variance**(-3/2)),p=f(s[n],-l).add(f(d,b(1/i.length,f(this.xmu,-2))));s[n]=f(s[n],l).add(T(b(p,i.length),b(f(d,2/i.length),this.xmu)))}return s}save(){return{type:this.type,inputShape:this.inputShape,weights:this.weights,bias:this.bias,weightsInitializer:this.weightsInitializer,biasInitializer:this.biasInitializer}}}class ue extends j{constructor(i){super();o(this,"forwardedInput");o(this,"inputShape");o(this,"outputShape");o(this,"activation");this.isTrainable=!1,this.type="activation",this.name=i.name,this.activation=i,this.inputShape=0,this.outputShape=this.inputShape,this.forwardedInput=[new c([])]}resize(i){this.inputShape=i,this.outputShape=this.inputShape}forward(i){this.input=i;for(let s=0;s<i.length;s++)this.forwardedInput[s]=this.activation.forward(i[s]);return this.forwardedInput}backward(i){let s=[];for(let n=0;n<i.length;n++)s[n]=this.activation.updateError(i[n],this.activation.backward(this.forwardedInput[n]));return s}serialize(){return JSON.stringify(this)}save(){return{type:this.type,name:this.name,inputShape:this.inputShape}}}class Ms extends j{constructor(i={}){super();o(this,"poolSize");o(this,"stride");o(this,"padding");o(this,"padAmt");o(this,"inputShape");o(this,"coords");o(this,"outputShape");this.type="maxpooling",this.poolSize=[2,2],i.poolSize&&(this.poolSize=i.poolSize instanceof Array?i.poolSize:[i.poolSize,i.poolSize],this.poolSize.map(s=>Math.floor(s))),this.stride=this.poolSize,i.stride&&(this.stride=i.stride instanceof Array?i.stride:[i.stride,i.stride],this.stride.map(s=>Math.floor(s))),this.padding=i.padding||!1,this.inputShape=i.inputShape?i.inputShape.slice():[1,1,1],this.inputShape.map(s=>Math.floor(s)),this.padAmt=xt(this.inputShape,this.padding,this.poolSize,this.stride),this.outputShape=At(this.inputShape,this.padAmt,this.poolSize,this.stride),this.coords=i.coords?i.coords.slice():[]}resize(i){this.inputShape=i instanceof Array?i.slice():[1,1,1],this.inputShape.map(s=>Math.floor(s)),this.padAmt=xt(this.inputShape,this.padding,this.poolSize,this.stride),this.outputShape=At(this.inputShape,this.padAmt,this.poolSize,this.stride)}forward(i){this.input=i;let s=[];for(let n=0;n<i.length;n++)this.coords[n]=[],s[n]=Oi(this.input[n],this.padding,this.poolSize,this.stride,this.coords[n]);return s}backward(i){let s=[];for(let n=0;n<this.input.length;n++){s[n]=y(this.inputShape);for(let r=0;r<this.coords[n].length;r++)s[n].data[this.coords[n][r][0]][this.coords[n][r][1]][this.coords[n][r][2]]=i[n].data[this.coords[n][r][0]][this.coords[n][r][3]][this.coords[n][r][4]]}return s}save(){return{type:this.type,poolSize:this.poolSize,stride:this.stride,padding:this.padding,inputShape:this.inputShape,coords:this.coords}}}const bs=e=>{switch(e){case"dense":return Ot;case"conv":return ys;case"maxpooling":return Ms;case"flatten":return zs;case"dropout":return Ss;case"norm":return oe;case"activation":return ue;default:return Ot}},ks=e=>{let t=bs(e.type);return new t(e)},Jt=e=>new Ot(e),Is=e=>new oe(e),Ft=e=>{const t=Pi(e);return new ue(t)};class Y{constructor(){o(this,"layers");o(this,"numLayers");o(this,"trainableLayers");o(this,"error");o(this,"loss");o(this,"lossFunction");o(this,"optimizer");o(this,"parameters");o(this,"batch");o(this,"batchSize");this.batch=0,this.parameters=0,this.layers=[],this.numLayers=0,this.loss="mse",this.lossFunction=zt(this.loss),this.trainableLayers=[],this.error=1,this.optimizer=rt(.1),this.batchSize=0}setLossFunction(t){this.loss=t,this.lossFunction=zt(this.loss)}compile(t){this.optimizer=t.optimizer||rt(.1),this.loss=t.loss||"mse",this.lossFunction=zt(this.loss)}add(t,i=!1){if(this.numLayers>0&&i==!1){let s=this.layers[this.numLayers-1].outputShape;t.resize(s)}t instanceof gt&&(this.trainableLayers.push(t),this.parameters+=t.parameters),this.layers.push(t),this.numLayers++}async predictOnBatch(t){let i=t;for(let s=0;s<this.numLayers;s++)i=this.layers[s].forward(i);return i}async predict(t){return(await this.predictOnBatch([t]))[0]}async train(t,i,s={epochs:1,batchSize:1,shuffle:!1}){let n=s.shuffle||!1,r=s.epochs||1;this.batchSize=s.batchSize||t.length;for(let a=0;a<r;a++)for(let l=0;l<t.length/this.batchSize;l++){let d=t.slice(l,l+this.batchSize),p=i.slice(l,l+this.batchSize);await this.trainOnBatch(d,p,n)}this.batch>t.length/this.batchSize&&(this.batch=0)}async trainOnBatch(t,i,s=!1){let n=t.length;this.batchSize==0&&(this.batchSize=n),s&&ei(t,i);let r=0,a=await this.predictOnBatch(t),l=[];for(let d=0;d<n;d++)r+=this.lossFunction.forward(a[d],i[d]),l[d]=this.lossFunction.backward(a[d],i[d]);for(let d=this.numLayers-1;d>=0;d--)l=this.layers[d].backward(l);this.batch++,r/=n,this.error=r,this.update(this.batch)}update(t){for(let i=0;i<this.trainableLayers.length;i++)this.trainableLayers[i].update(this.optimizer,this.batchSize,t)}mutateRandomLayer(t=!1,i=.1,s=.1){let n=Math.floor(Math.random()*this.trainableLayers.length),r=[-s,s];this.trainableLayers[n].mutateWeights(i,r),t!=!1&&this.trainableLayers[n].mutateBias(i,r)}mutate(t=!1,i=.1,s=.5){let n=[-s,s];for(let r=0;r<this.trainableLayers.length;r++)this.trainableLayers[r].mutateWeights(i,n),t!=!1&&this.trainableLayers[r].mutateBias(i,n)}save(){let t=[];for(let i=0;i<this.layers.length;i++)t.push(this.layers[i].save());return JSON.stringify({loss:this.loss,optimizer:this.optimizer,layers:t})}static loadModel(t){let i=new Y;for(let s=0;s<t.layers.length;s++){let n;t.layers[s].type=="activation"?(n=Ft(t.layers[s].name),i.add(n)):(n=ks(t.layers[s]),i.add(n,!0))}return i.compile({loss:t.loss,optimizer:ws(t.optimizer)}),i}copy(){return Y.loadModel(JSON.parse(this.save()))}static copy(t){return Y.loadModel(JSON.parse(t.save()))}}class vt{constructor(t){o(this,"positionY");o(this,"velocity");o(this,"score");o(this,"brain");this.positionY=innerHeight/2,this.velocity=0,this.score=0,t instanceof Y?(this.brain=t.copy(),this.brain.mutate(!0,.25,.1)):(this.brain=new Y,this.brain.add(Is({inputShape:3})),this.brain.add(Jt({units:2})),this.brain.add(Ft("tanh")),this.brain.add(Jt({units:1})),this.brain.add(Ft("tanh")))}async think(t){let i=null,s=1/0;for(let a=0;a<t.length;a++){let l=t[a].x-Z;l+pe>0&&l<s&&(s=l,i=t[a])}if(i==null)return;let n=[];n.push(this.velocity),n.push(this.positionY),n.push(i.centery),(await this.brain.predict(Kt(n))).data[0]>0&&this.jump()}draw(){ve(W,Z,this.positionY,N),St(W,et(255,255,0))}isDead(){return this.positionY+N>=innerHeight?(this.positionY=innerHeight-N,this.velocity=0,!0):this.positionY-N<=0?(this.positionY=N,this.velocity=0,!0):!1}clone(){return new vt(this.brain)}jump(){this.velocity=Lt}save(){return this.brain.save()}update(){this.velocity+=ce,this.positionY+=this.velocity,this.score+=.001,this.isDead(),this.draw()}}function As(e){let t=xs(e),i=[];for(let s=0;s<de;s++)i[s]=t.clone();return i}function xs(e){let t=0,i=e[0];for(let s=0;s<e.length;s++){let n=e[s].score;n>t&&(t=n,i=e[s])}return i}class Cs{constructor(){o(this,"centery");o(this,"top");o(this,"bottom");o(this,"x");o(this,"w");o(this,"speed");this.centery=Ve(v,innerHeight-v),this.top=this.centery-v/2,this.bottom=innerHeight-(this.centery+v/2),this.x=innerWidth,this.w=Gt,this.speed=5}hits(t){return(t.positionY-N<=this.top||t.positionY+N>innerHeight-this.bottom)&&Z>this.x&&Z<this.x+this.w}draw(){Rt(W,this.x,innerHeight-this.bottom,this.w,this.bottom),St(W,et(0,200,0)),Rt(W,this.x,0,this.w,this.top),St(W,et(0,200,0))}update(){this.x-=this.speed}offscreen(){return this.x<-this.w}}const at=document.querySelector("canvas"),W=at.getContext("2d");let de=70,F=[],Et=[],E=[],N,pe,tt=0,G=1,v,Gt,Z,ce,Lt;We(at);function Os(){at.width=innerWidth,at.height=innerHeight,v=innerHeight/7,Gt=v/1.5,N=v/7,pe=Gt+N/2,Z=innerWidth/10,Lt=-v/12,ce=-Lt/10,fe();for(let e=0;e<de;e++){let t=new vt;F[e]=t,Et[e]=t}}addEventListener("keydown",e=>{e.keyCode==32&&F[0].jump(),e.keyCode==37&&(G-=4),e.keyCode==39&&(G+=1),G=Mt(G,0,70)});let Vt=!1,Dt=!1;addEventListener("touchstart",e=>{e.targetTouches[0].pageX>innerWidth/2?Vt=!0:Dt=!0});addEventListener("touchend",()=>{Vt=!1,Dt=!1});function Fs(){Vt&&(G+=.25,G=Mt(G,0,70)),Dt&&(G-=1,G=Mt(G,0,70))}function fe(){tt=0,E=[]}function Es(){fe(),F=As(Et),Et=F.slice()}function Gs(){qe(W,et(125,255,255)),Fs();for(let e=0;e<G;e++)Ls();for(let e=0;e<E.length;e++)E[e].draw();F.length==0&&Es();for(let e=0;e<F.length;e++)F[e].draw()}Os();Bt.animate(Gs);Ut();function Ls(){for(let e=E.length-1;e>=0;e--)E[e].update(),E[e].offscreen()&&E.splice(e,1);for(let e=F.length-1;e>=0;e--){let t=F[e];t.think(E),t.update();for(let i=0;i<E.length;i++)if(E[i].hits(F[e])){F.splice(e,1);break}t.isDead()&&F.splice(e,1)}tt%72==0&&(E.push(new Cs),tt=0),tt++}
